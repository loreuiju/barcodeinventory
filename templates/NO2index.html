<!DOCTYPE html>
<html>
<head>
    <title>Inventario Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>

<h1>Inventario con Código de Barras</h1>

<button id="btnScan">Escanear Código</button>

<div id="resultado"></div>

<script>
    const btnScan = document.getElementById('btnScan');
    const resultado = document.getElementById('resultado');

    btnScan.addEventListener('click', () => {
        Quagga.init({
            inputStream : {
                name : "Live",
                type : "LiveStream",
                target: document.body,
            },
            decoder : {
                readers : ["ean_reader"]
            }
        }, function(err) {
            if (err) {
                console.log(err);
                resultado.innerHTML = "Error al iniciar cámara: " + err;
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected(function(data) {
            let codigo = data.codeResult.code;
            Quagga.stop();
            resultado.innerHTML = "Escaneado: " + codigo;

            fetch('/buscar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({codigo})
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    let cantidad = prompt("¿Cuántas unidades entran?");
                    if (cantidad) {
                        fetch('/guardar', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({producto: data.producto, cantidad: parseInt(cantidad)})
                        })
                        .then(res => res.json())
                        .then(resp => {
                            resultado.innerHTML = resp.msg;
                        });
                    }
                } else {
                    resultado.innerHTML = data.msg;
                }
            });
        });
    });
</script>

</body>
</html>
